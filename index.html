<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡åå¥½æ’åºä¸é€‰æ‹©å®éªŒ</title>
    <style>
        /* ========== åŸºç¡€ä¸å…¨å±€æ ·å¼ ========== */
        * {
            box-sizing: border-box;
            user-select: none;
        }
        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            color: #333;
            line-height: 1.6;
        }
        #experiment-container {
            max-width: 1200px;
            margin: 20px auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            padding: 0;
        }

        /* ========== å¤´éƒ¨æ ‡é¢˜åŒºåŸŸ ========== */
        .header {
            background: linear-gradient(135deg, #4a69bd 0%, #2d3a8c 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0 0 8px 0;
            font-size: 1.8em;
        }
        .header p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.95em;
        }

        /* ========== ä¸»å†…å®¹åŒºé€šç”¨æ ·å¼ ========== */
        .main-content {
            padding: 30px;
        }
        .stage-title {
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }
        .instructions {
            background-color: #f8f9fa;
            border-left: 4px solid #4a69bd;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 0 8px 8px 0;
        }
        .instructions p {
            margin: 10px 0;
        }

        /* ========== IDè¾“å…¥æ¡†æ ·å¼ ========== */
        .id-input-section {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin: 25px auto;
            max-width: 600px;
            text-align: left;
        }
        .id-input-group {
            margin: 20px 0;
        }
        .id-label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        .id-input {
            width: 100%;
            padding: 12px 15px;
            font-size: 1em;
            border: 2px solid #d1d9e6;
            border-radius: 8px;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }
        .id-input:focus {
            border-color: #4a69bd;
            box-shadow: 0 0 0 3px rgba(74, 105, 189, 0.2);
            outline: none;
        }
        .id-input:invalid {
            border-color: #e74c3c;
        }
        .id-hint {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 8px;
            font-style: italic;
        }
        .id-example {
            background-color: #e8f4fd;
            padding: 12px 15px;
            border-radius: 6px;
            margin-top: 15px;
            border-left: 4px solid #3498db;
        }
        .id-example code {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }

        /* ========== æ’åºä»»åŠ¡ä¸“å±å¸ƒå±€ ========== */
        .sorting-interface {
            display: flex;
            gap: 30px;
            margin-top: 20px;
        }
        @media (max-width: 1000px) {
            .sorting-interface {
                flex-direction: column;
            }
        }

        /* æ’åºåŒºä¸å›¾ç‰‡æ± çš„é€šç”¨é¢æ¿æ ·å¼ */
        .panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .panel-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
            padding: 15px 0 10px;
            text-align: center;
            border-bottom: 2px solid #eee;
            margin-bottom: 15px;
        }

        /* ç½‘æ ¼å®¹å™¨ */
        .grid-container {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 15px;
            padding: 20px;
            background-color: #f8fafc;
            border-radius: 12px;
            min-height: 500px;
        }

        /* ========== æ’åºæ§½æ ·å¼ ========== */
        .rank-slot {
            background: white;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            border: 2px solid #d1d9e6;
        }
        .rank-slot.empty {
            border-style: dashed;
            background-color: #f8fafc;
        }
        .rank-slot.filled {
            border-color: #38b2ac;
            border-style: solid;
        }
        .rank-slot.drag-over {
            border-color: #f56565;
            background-color: #fff5f5;
            transform: scale(1.02);
        }
        .slot-header {
            padding: 10px 5px;
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid #e2e8f0;
        }
        .rank-number {
            font-size: 1.4em;
            font-weight: 800;
            color: #2c3e50;
            line-height: 1;
        }
        .rank-text {
            font-size: 0.75em;
            color: #718096;
            margin-top: 3px;
        }
        .slot-image {
            flex: 1;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            min-height: 120px;
        }

        /* ========== å¯æ‹–æ‹½å›¾ç‰‡æ ·å¼ ========== */
        .draggable-img {
            border-radius: 8px;
            cursor: grab;
            transition: all 0.3s ease;
            background-size: cover;
            background-position: center;
            box-shadow: 0 4px 8px rgba(66, 153, 225, 0.2);
            border: 3px solid #4299e1;
        }
        .draggable-img.in-pool:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 15px rgba(66, 153, 225, 0.3);
            border-color: #3182ce;
        }
        .draggable-img.dragging {
            opacity: 0.8;
            cursor: grabbing;
            transform: scale(1.05) rotate(2deg);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            position: relative;
        }
        .draggable-img.in-slot {
            border-color: #38b2ac;
            box-shadow: 0 4px 10px rgba(56, 178, 172, 0.3);
        }

        /* ========== é€‰æ‹©ä»»åŠ¡æ ·å¼ ========== */
        .choice-options-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 25px;
            margin: 30px 0;
        }
        .choice-option {
            width: 150px;
            height: 210px;
            border-radius: 10px;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            border: 4px solid transparent;
            transition: all 0.3s ease;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        .choice-option:hover {
            transform: scale(1.08);
            border-color: #9f7aea;
        }
        .choice-option.selected {
            border-color: #00b5d8;
            box-shadow: 0 0 0 4px rgba(0, 181, 216, 0.3);
            transform: scale(1.05);
        }

        /* ========== æ§åˆ¶ä¸è¿›åº¦åŒºåŸŸ ========== */
        .control-area {
            text-align: center;
            padding: 25px;
            background-color: #f8fafc;
            border-top: 1px solid #e2e8f0;
            margin-top: 20px;
        }
        .progress-info {
            font-size: 1.1em;
            font-weight: bold;
            color: #2b6cb0;
            padding: 12px 25px;
            background-color: #ebf8ff;
            border-radius: 50px;
            display: inline-block;
            margin-bottom: 20px;
            border: 1px solid #bee3f8;
        }
        .progress-info.complete {
            background-color: #f0fff4;
            color: #276749;
            border-color: #c6f6d5;
        }

        /* ========== æŒ‰é’®æ ·å¼ ========== */
        .action-button {
            background: linear-gradient(135deg, #4a69bd 0%, #2d3a8c 100%);
            color: white;
            border: none;
            padding: 16px 40px;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(74, 105, 189, 0.3);
        }
        .action-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 7px 18px rgba(74, 105, 189, 0.4);
        }
        .action-button:active:not(:disabled) {
            transform: translateY(-1px);
        }
        .action-button:disabled {
            background: linear-gradient(135deg, #cbd5e0 0%, #a0aec0 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* ========== å®Œæˆé¡µé¢æ ·å¼ ========== */
        .completion-screen {
            text-align: center;
            padding: 60px 30px;
        }
        .completion-icon {
            font-size: 4em;
            color: #38a169;
            margin-bottom: 20px;
        }
        .download-note {
            color: #e53e3e;
            font-weight: bold;
            margin-top: 30px;
            padding: 15px;
            background-color: #fff5f5;
            border-radius: 8px;
            border-left: 4px solid #e53e3e;
        }
           /* ========== ã€ä¼˜åŒ–ã€‘å›¾ç‰‡åŠ è½½ä¼˜åŒ–ï¼šå ä½ç¬¦ä¸è¿‡æ¸¡ ========== */
        .slot-image, .choice-option, .draggable-img {
            position: relative;
            background-color: #f1f5f9 !important; /* ç»Ÿä¸€çš„æµ…ç°è‰²å ä½èƒŒæ™¯ */
            overflow: hidden;
        }
        /* åˆ›å»ºä¸€ä¸ªé—ªçƒçš„åŠ è½½åŠ¨ç”» */
        .slot-image::before, .choice-option::before, .draggable-img::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.6), 
                transparent);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            100% { left: 200%; }
        }
        /* è¿™æ˜¯å®é™…å›¾ç‰‡æ‰€åœ¨çš„å±‚ï¼Œåˆå§‹éšè— */
        .slot-image::after, .choice-option::after, .draggable-img::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        /* å½“å›¾ç‰‡åŠ è½½å®Œæˆåï¼Œæ·¡å…¥æ˜¾ç¤ºå¹¶åœæ­¢åŠ¨ç”» */
        .slot-image.loaded::after, 
        .choice-option.loaded::after,
        .draggable-img.loaded::after {
            opacity: 1;
        }
        .loaded::before {
            animation: none; /* åŠ è½½å®Œæˆååœæ­¢é—ªçƒåŠ¨ç”» */
            display: none;
        }    
    </style>
</head>
<body>
    <!-- å®éªŒçš„ä¸»å®¹å™¨ï¼Œæ‰€æœ‰å†…å®¹åŠ¨æ€åŠ è½½äºæ­¤ -->
    <div id="experiment-container"></div>

    <script>
        // ==================== å®éªŒé…ç½®ä¸å…¨å±€çŠ¶æ€ ====================
        const CONFIG = {
            // æ‚¨çš„12å¼ å›¾ç‰‡URL
            imageUrls: [
                'poster_1.png',
                'poster_2.png',
                'poster_3.png',
                'poster_4.png',
                'poster_5.png',
                'poster_6.png',
                'poster_7.png',
                'poster_8.png',
                'poster_9.png',
                'poster_10.png',
                'poster_11.png',
                'poster_12.png'
            ],
            // æ’åºæ§½ä½å®šä¹‰
            rankSlots: [
                { rank: 1, text: 'æœ€å–œæ¬¢' },
                { rank: 2, text: 'ç¬¬2å–œæ¬¢' },
                { rank: 3, text: 'ç¬¬3å–œæ¬¢' },
                { rank: 4, text: 'ç¬¬4å–œæ¬¢' },
                { rank: 5, text: 'ç¬¬5å–œæ¬¢' },
                { rank: 6, text: 'ç¬¬6å–œæ¬¢' },
                { rank: 7, text: 'ç¬¬7å–œæ¬¢' },
                { rank: 8, text: 'ç¬¬8å–œæ¬¢' },
                { rank: 9, text: 'ç¬¬9å–œæ¬¢' },
                { rank: 10, text: 'ç¬¬10å–œæ¬¢' },
                { rank: 11, text: 'ç¬¬11å–œæ¬¢' },
                { rank: 12, text: 'æœ€ä¸å–œæ¬¢' }
            ]
        };

                // ==================== ã€ä¼˜åŒ–ã€‘å›¾ç‰‡åŠ è½½ç®¡ç†å™¨ ====================
        const ImageLoader = {
            // å­˜å‚¨å·²åŠ è½½çš„å›¾ç‰‡ï¼Œé¿å…é‡å¤åŠ è½½
            cache: new Map(),
            
            // åŠ è½½å•å¼ å›¾ç‰‡
            load(url) {
                // å¦‚æœå·²ç»åœ¨ç¼“å­˜ä¸­ï¼Œç›´æ¥è¿”å›Promise
                if (this.cache.has(url)) {
                    return Promise.resolve(this.cache.get(url));
                }
                
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => {
                        this.cache.set(url, img);
                        resolve(img);
                    };
                    img.onerror = reject;
                    img.src = url;
                });
            },
            
            // æŒ‰éœ€åŠ è½½ï¼šåªåŠ è½½å³å°†æ˜¾ç¤ºçš„å›¾ç‰‡
            loadLazy(element, url) {
                // å¦‚æœå·²ç»åœ¨ç¼“å­˜ä¸­ï¼Œç«‹å³åº”ç”¨
                if (this.cache.has(url)) {
                    this.applyImage(element, url);
                    return Promise.resolve();
                }
                
                // å¦åˆ™å¼€å§‹åŠ è½½ï¼Œä½†è®¾ç½®ä¸€ä¸ªæ›´ç§¯æçš„åŠ è½½ç­–ç•¥
                const loadPromise = this.load(url);
                loadPromise.then(() => this.applyImage(element, url));
                return loadPromise;
            },
            
            // å°†å›¾ç‰‡åº”ç”¨åˆ°å…ƒç´ 
            applyImage(element, url) {
                // ç»™å…ƒç´ æ·»åŠ loadedç±»ï¼Œè§¦å‘CSSæ·¡å…¥æ•ˆæœ
                setTimeout(() => {
                    element.style.backgroundImage = `url('${url}')`;
                    element.classList.add('loaded');
                }, 30);
            }
        
            // å…¨å±€å®éªŒæ•°æ®å¯¹è±¡
        const EXPERIMENT = {
            // === å‚ä¸è€…ä¿¡æ¯ ===
            participantId: '',           // å‚ä¸è€…IDï¼ˆå§“åæ‹¼éŸ³é¦–å­—æ¯+å‡ºç”Ÿå¹´æœˆï¼‰
            
            // === æ—¶é—´è®°å½• ===
            timestamps: {
                experimentStart: null,      // å®éªŒå¼€å§‹
                sortingStart: null,         // æ’åºé˜¶æ®µå¼€å§‹
                sortingEnd: null,           // æ’åºé˜¶æ®µç»“æŸ
                choiceStart: null,          // é€‰æ‹©é˜¶æ®µå¼€å§‹
                choiceEnd: null             // é€‰æ‹©é˜¶æ®µç»“æŸ
            },
            // === æ ¸å¿ƒç»“æœ ===
            finalRanking: new Array(12).fill(null), // è®°å½•æ¯å¼ å›¾ç‰‡çš„æœ€ç»ˆæ’å(1-12)ï¼Œnullè¡¨ç¤ºæœªæ’åº
            selectedImageId: null,          // è¢«é€‰ä¸ºå°é¢çš„å›¾ç‰‡ID (0-11)
            // === è¿‡ç¨‹æ•°æ® ===
            dragEvents: [],                 // è®°å½•æ¯æ¬¡æ‹–æ‹½äº‹ä»¶ï¼ˆå¯é€‰ï¼‰
            isSortingComplete: false        // æ’åºæ˜¯å¦å®Œæˆæ ‡è®°
        };

        // å½“å‰å®éªŒé˜¶æ®µ
        let currentStage = 'id_input'; // id_input, instructions, sorting, choice, finish

        // ==================== å·¥å…·å‡½æ•° ====================
        /**
         * å°†æ•°æ®ä¿å­˜ä¸ºJSONæ–‡ä»¶å¹¶è§¦å‘ä¸‹è½½
         * @param {Object} data - è¦ä¿å­˜çš„æ•°æ®å¯¹è±¡
         */
        function saveDataAsJSON(data) {
            // ä½¿ç”¨ID+æ—¶é—´æˆ³çš„æ ¼å¼ç”Ÿæˆæ–‡ä»¶å
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-').replace('T', '_');
            const idPrefix = EXPERIMENT.participantId ? EXPERIMENT.participantId : 'anonymous';
            const filename = `${idPrefix}_${timestamp}.json`;

            // åˆ›å»ºæ•°æ®å­—ç¬¦ä¸²
            const dataStr = JSON.stringify(data, null, 2); // ç¼©è¿›2æ ¼ï¼Œæ–¹ä¾¿é˜…è¯»
            const dataBlob = new Blob([dataStr], { type: 'application/json' });

            // åˆ›å»ºä¸‹è½½é“¾æ¥å¹¶è§¦å‘ç‚¹å‡» 
            const downloadUrl = URL.createObjectURL(dataBlob);
            const downloadLink = document.createElement('a');
            downloadLink.href = downloadUrl;
            downloadLink.download = filename;

            // æ·»åŠ åˆ°é¡µé¢ï¼Œç‚¹å‡»ï¼Œç„¶åæ¸…ç†
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);

            // é‡Šæ”¾å†…å­˜
            setTimeout(() => URL.revokeObjectURL(downloadUrl), 100);
        }

        /**
         * ç”Ÿæˆå¹¶ä¸‹è½½æ•°æ®æ‘˜è¦æ–‡ä»¶ï¼ˆTXTæ ¼å¼ï¼‰
         * @param {Object} finalData - prepareFinalData()ç”Ÿæˆçš„æ•°æ®å¯¹è±¡
         */
        function generateAndDownloadSummary(finalData) {
            // æ„å»ºæ˜“äºé˜…è¯»çš„æ–‡æœ¬æ‘˜è¦
            const summaryText = `
===============================
       å®éªŒæ•°æ®æ‘˜è¦
===============================
è¢«è¯•ID: ${EXPERIMENT.participantId}
å®Œæˆæ—¶é—´: ${finalData.completion_time}

========== å…³é”®ç»“æœ ==========
æœ€ç»ˆé€‰æ‹©çš„å°é¢å›¾ç‰‡ ID: ${finalData.selected_image.id}
è¯¥å›¾ç‰‡åœ¨æ‚¨æ’åºä¸­çš„åæ¬¡: ç¬¬${finalData.selected_image.actual_rank}å
è¯¥å›¾ç‰‡çš„è®¿é—®åœ°å€: 
${finalData.selected_image.url}

========== å†³ç­–è€—æ—¶ ==========
æ’åºé˜¶æ®µè€—æ—¶: ${finalData.durations_seconds.sorting_stage ? finalData.durations_seconds.sorting_stage.toFixed(2) : 'N/A'} ç§’
é€‰æ‹©é˜¶æ®µè€—æ—¶: ${finalData.durations_seconds.choice_stage ? finalData.durations_seconds.choice_stage.toFixed(2) : 'N/A'} ç§’
å®éªŒæ€»è€—æ—¶: ${finalData.durations_seconds.total_experiment ? finalData.durations_seconds.total_experiment.toFixed(2) : 'N/A'} ç§’

========== æ’åºç»“æœ (å›¾ç‰‡ID -> æ’å) ==========
${finalData.final_ranking.map((rank, idx) => `  å›¾ç‰‡ ${idx} (ID: ${idx}) -> ç¬¬ ${rank} å`).join('\n')}

========== è¿‡ç¨‹æŒ‡æ ‡ ==========
æ€»æ‹–æ‹½æ“ä½œæ¬¡æ•°: ${finalData.drag_events_count}
è¯¦ç»†äº‹ä»¶è®°å½•å·²ä¿å­˜åœ¨åŒåçš„JSONæ–‡ä»¶ä¸­ã€‚
===============================
`;

            // ä½¿ç”¨ID+æ—¶é—´æˆ³çš„æ ¼å¼ç”Ÿæˆæ–‡ä»¶å
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-').replace('T', '_');
            const idPrefix = EXPERIMENT.participantId ? EXPERIMENT.participantId : 'anonymous';
            const filename = `${idPrefix}_${timestamp}_summary.txt`;
            
            const blob = new Blob([summaryText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        /**
         * å‡†å¤‡æœ€ç»ˆè¦ä¿å­˜çš„æ•°æ®
         */
        function prepareFinalData() {
            // è®¡ç®—å„é˜¶æ®µè€—æ—¶ï¼ˆå•ä½ï¼šç§’ï¼‰
            const sortingDuration = EXPERIMENT.timestamps.sortingEnd && EXPERIMENT.timestamps.sortingStart ?
                (EXPERIMENT.timestamps.sortingEnd - EXPERIMENT.timestamps.sortingStart) / 1000 : null;
            const choiceDuration = EXPERIMENT.timestamps.choiceEnd && EXPERIMENT.timestamps.choiceStart ?
                (EXPERIMENT.timestamps.choiceEnd - EXPERIMENT.timestamps.choiceStart) / 1000 : null;
            const totalDuration = EXPERIMENT.timestamps.experimentStart ?
                (Date.now() - EXPERIMENT.timestamps.experimentStart) / 1000 : null;

            // æ„å»ºæœ€ç»ˆæ•°æ®å¯¹è±¡
            return {
                // åŸºæœ¬ä¿¡æ¯
                participant_id: EXPERIMENT.participantId,
                completion_time: new Date().toISOString(),

                // æ—¶é—´æ•°æ®
                timestamps: {
                    experiment_start: EXPERIMENT.timestamps.experimentStart,
                    sorting_start: EXPERIMENT.timestamps.sortingStart,
                    sorting_end: EXPERIMENT.timestamps.sortingEnd,
                    choice_start: EXPERIMENT.timestamps.choiceStart,
                    choice_end: EXPERIMENT.timestamps.choiceEnd
                },
                durations_seconds: {
                    sorting_stage: sortingDuration,
                    choice_stage: choiceDuration,
                    total_experiment: totalDuration
                },

                // æ ¸å¿ƒç»“æœæ•°æ®
                final_ranking: EXPERIMENT.finalRanking,
                selected_image: {
                    id: EXPERIMENT.selectedImageId,
                    url: EXPERIMENT.selectedImageId !== null ?
                        CONFIG.imageUrls[EXPERIMENT.selectedImageId] : null,
                    // è®°å½•è¢«é€‰ä¸­å›¾ç‰‡åœ¨æœ€ç»ˆæ’åºä¸­çš„å®é™…åæ¬¡
                    actual_rank: EXPERIMENT.selectedImageId !== null ? 
                        EXPERIMENT.finalRanking[EXPERIMENT.selectedImageId] : null
                },

                // è¿‡ç¨‹æ•°æ®
                drag_events_count: EXPERIMENT.dragEvents.length,
                drag_events: EXPERIMENT.dragEvents, // åŒ…å«è¯¦ç»†æ‹–æ‹½è®°å½•

                // å®éªŒé…ç½®ä¿¡æ¯
                config: {
                    total_images: CONFIG.imageUrls.length,
                    image_urls: CONFIG.imageUrls
                }
            };
        }

        // ==================== é˜¶æ®µä¸€ï¼šIDè¾“å…¥ ====================
        function showIdInput() {
            currentStage = 'id_input';

            const html = `
                <div class="header">
                    <h1>å›¾ç‰‡åå¥½å®éªŒ</h1>
                    <p>è¯·å…ˆå¡«å†™æ‚¨çš„IDç¼–å·</p>
                </div>
                <div class="main-content">
                    <div class="id-input-section">
                        <h2 style="color: #2c3e50; margin-top: 0;">è¯·è¾“å…¥æ‚¨çš„IDç¼–å·</h2>
                        
                        <div class="id-input-group">
                            <label class="id-label" for="participant-id">IDç¼–å·ï¼š</label>
                            <input type="text" 
                                   id="participant-id" 
                                   class="id-input" 
                                   placeholder="ä¾‹å¦‚: ZS199005"
                                   required
                                   pattern="[A-Za-z]{2,}[0-9]{6}"
                                   title="è¯·ä½¿ç”¨å§“åæ‹¼éŸ³é¦–å­—æ¯(2ä¸ªä»¥ä¸Šå­—æ¯) + å‡ºç”Ÿå¹´æœˆ(6ä½æ•°å­—)ï¼Œä¾‹å¦‚: ZS199005">
                            <div class="id-hint">è¯·ä¿æŒä¸å‰é¢é—®å·ä¸­å¡«å†™çš„IDç›¸åŒ</div>
                        </div>
                        
                        <div class="id-example">
                            <p><strong>IDæ ¼å¼è¯´æ˜ï¼š</strong></p>
                            <p>å§“åæ‹¼éŸ³é¦–å­—æ¯ (2ä¸ªä»¥ä¸Šå­—æ¯) + å‡ºç”Ÿå¹´æœˆ (6ä½æ•°å­—)</p>
                            <p><strong>ç¤ºä¾‹ï¼š</strong></p>
                            <ul>
                                <li>å¼ ä¸‰ï¼Œ1990å¹´5æœˆå‡ºç”Ÿ â†’ <code>ZS199005</code></li>
                                <li>æå››ï¼Œ1995å¹´12æœˆå‡ºç”Ÿ â†’ <code>LS199512</code></li>
                                <li>ç‹å°æ˜ï¼Œ1988å¹´8æœˆå‡ºç”Ÿ â†’ <code>WXM198808</code></li>
                            </ul>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button id="confirm-id-btn" class="action-button">ç¡®è®¤IDï¼Œç»§ç»­å®éªŒ</button>
                    </div>
                </div>
            `;

            document.getElementById('experiment-container').innerHTML = html;
            
            // è®¾ç½®IDç¡®è®¤æŒ‰é’®äº‹ä»¶
            document.getElementById('confirm-id-btn').addEventListener('click', function() {
                const idInput = document.getElementById('participant-id');
                
                if (idInput.checkValidity()) {
                    EXPERIMENT.participantId = idInput.value.trim();
                    showInstructions();
                } else {
                    // å¦‚æœè¾“å…¥æ— æ•ˆï¼Œæ˜¾ç¤ºæµè§ˆå™¨é»˜è®¤éªŒè¯æ¶ˆæ¯
                    idInput.reportValidity();
                }
            });
            
            // å…è®¸æŒ‰Enteré”®æäº¤
            document.getElementById('participant-id').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('confirm-id-btn').click();
                }
            });
        }

        // ==================== é˜¶æ®µäºŒï¼šæ˜¾ç¤ºæŒ‡å¯¼è¯­ (ä»…æ’åºä»»åŠ¡) ====================
        function showInstructions() {
            currentStage = 'instructions';
            EXPERIMENT.timestamps.experimentStart = Date.now();

            const html = `
                <div class="header">
                    <h1>å›¾ç‰‡åå¥½å®éªŒ</h1>
                    <p>è¯·ä»”ç»†é˜…è¯»ä»¥ä¸‹è¯´æ˜ï¼Œç„¶åå¼€å§‹å®éªŒ</p>
                </div>
                <div class="main-content">
                    <div class="instructions">
                        <h2>å®éªŒä»»åŠ¡</h2>
                        <p>åœ¨æœ¬é˜¶æ®µï¼Œæ‚¨çš„ä»»åŠ¡æ˜¯å¯¹ä¸€ç³»åˆ—å›¾ç‰‡è¿›è¡Œä¸ªäººå–œå¥½æ’åºã€‚</p>
                        <p><b>åç»­æˆ‘ä»¬å°†æ ¹æ®æ‚¨çš„æ’åºä¸ºæ‚¨åˆ¶ä½œä¸“å±å°é¢çš„ç¬”è®°æœ¬ã€‚</b></p>
                        <p>è¯·å°† <b>å³ä¾§å›¾ç‰‡æ± </b> ä¸­çš„12å¼ å›¾ç‰‡ï¼ŒæŒ‰ç…§æ‚¨çš„ä¸ªäººåå¥½ï¼Œä» <b style="color:#2d3a8c;">æœ€å–œæ¬¢ï¼ˆ1ï¼‰</b> åˆ° <b style="color:#2d3a8c;">æœ€ä¸å–œæ¬¢ï¼ˆ12ï¼‰</b> æ‹–æ‹½åˆ° <b>å·¦ä¾§æ’åºåŒº</b>ã€‚</p>
                        
                        <h2>æ“ä½œè¯´æ˜</h2>
                        <ul>
                            <li><b>æ‹–æ‹½æ’åº</b>ï¼šç‚¹å‡»å›¾ç‰‡æ± ä¸­çš„å›¾ç‰‡å¹¶æŒ‰ä½ï¼Œæ‹–æ‹½åˆ°å·¦ä¾§æ’åºåŒºçš„ä»»æ„ä½ç½®ã€‚</li>
                            <li><b>è°ƒæ•´é¡ºåº</b>ï¼šå·²æ’åºçš„å›¾ç‰‡ä½ç½®æ˜¯å¯ä»¥è°ƒæ•´çš„ï¼Œåªè¦æ‹–åŠ¨å›¾ç‰‡æ± å†…çš„å›¾ç‰‡å°†å…¶æ”¾åˆ°æ–°ä½ç½®å³å¯å®ç°è°ƒæ•´ã€‚</li>
                            <li><b>å®Œæˆè¦æ±‚</b>ï¼šå¿…é¡»å°†å…¨éƒ¨12å¼ å›¾ç‰‡æ”¾å…¥æ’åºåŒºåï¼Œæ‰èƒ½è¿›å…¥ä¸‹ä¸€æ­¥ã€‚</li>
                        </ul>
                        
                        <p style="margin-top: 25px; color: #4a5568; font-style: italic;">
                            å»ºè®®ä½¿ç”¨ Chrome æˆ– Edge æµè§ˆå™¨ï¼Œå¹¶åœ¨ç”µè„‘ä¸Šå®Œæˆå®éªŒï¼Œä»¥è·å¾—æœ€ä½³ä½“éªŒã€‚
                        </p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 40px;">
                        <button id="start-btn" class="action-button">æˆ‘æ˜ç™½äº†ï¼Œå¼€å§‹æ’åº</button>
                    </div>
                </div>
            `;

            document.getElementById('experiment-container').innerHTML = html;
            document.getElementById('start-btn').addEventListener('click', showSortingStage);
        }

        // ==================== é˜¶æ®µä¸‰ï¼šæ’åºä»»åŠ¡ ====================
        function showSortingStage() {
            currentStage = 'sorting';
            EXPERIMENT.timestamps.sortingStart = Date.now();

            // ç”Ÿæˆæ’åºæ§½ä½çš„HTML
            let slotsHTML = '';
            CONFIG.rankSlots.forEach(slot => {
                slotsHTML += `
                    <div class="rank-slot empty" data-rank="${slot.rank}" id="slot-${slot.rank}">
                        <div class="slot-header">
                            <div class="rank-number">${slot.rank}</div>
                            <div class="rank-text">${slot.text}</div>
                        </div>
                        <div class="slot-image" id="img-in-slot-${slot.rank}"></div>
                    </div>
                `;
            });

            // ç”Ÿæˆå›¾ç‰‡æ± çš„HTML
           // ======ã€ä¿®æ”¹ã€‘ç”Ÿæˆå›¾ç‰‡æ± çš„HTML - ä½¿ç”¨data-srcå­˜å‚¨è·¯å¾„ ======
            let poolHTML = '';
            CONFIG.imageUrls.forEach((url, index) => {
                poolHTML += `
                    <div class="draggable-img in-pool" 
                         id="img-${index}"
                         data-id="${index}"
                         data-src="${url}"> <!-- ä¿®æ”¹è¿™é‡Œï¼šç§»é™¤styleï¼Œæ·»åŠ data-src -->
                    </div>
                `;
            });
            const html = `
                <div class="header">
                    <h1>ç¬¬ä¸€æ­¥ï¼šå›¾ç‰‡æ’åº</h1>
                    <p>è¯·ä»æœ€å–œæ¬¢ï¼ˆ1ï¼‰åˆ°æœ€ä¸å–œæ¬¢ï¼ˆ12ï¼‰ä¸ºå›¾ç‰‡æ’åº</p>
                </div>
                <div class="main-content">
                    <div class="sorting-interface">
                        <!-- å·¦ä¾§ï¼šæ’åºåŒº -->
                        <div class="panel">
                            <div class="panel-title">ğŸ† æ’åºåŒº</div>
                            <div class="grid-container" id="sorting-area">
                                ${slotsHTML}
                            </div>
                        </div>
                        
                        <!-- å³ä¾§ï¼šå›¾ç‰‡æ±  -->
                        <div class="panel">
                            <div class="panel-title">ğŸ“š å›¾ç‰‡æ± ï¼ˆå…±12å¼ ï¼‰</div>
                            <div class="grid-container" id="image-pool">
                                ${poolHTML}
                            </div>
                        </div>
                    </div>
                    
                    <div class="control-area">
                        <div id="progress-display" class="progress-info">å·²æ’åºï¼š0 / 12 å¼ å›¾ç‰‡</div>
                        <button id="continue-btn" class="action-button" disabled>å®Œæˆæ’åºï¼Œè¿›å…¥ä¸‹ä¸€æ­¥</button>
                    </div>
                </div>
            `;

            document.getElementById('experiment-container').innerHTML = html;
            
            // è®¾ç½®æ‹–æ‹½äº‹ä»¶ç›‘å¬
            setupDragAndDrop();
            
            // è®¾ç½®ç»§ç»­æŒ‰é’®äº‹ä»¶
            document.getElementById('continue-btn').addEventListener('click', () => {
                EXPERIMENT.timestamps.sortingEnd = Date.now();
                // æ’åºå®Œæˆåè¿›å…¥é€‰æ‹©æŒ‡å¯¼è¯­
                showChoiceInstructions();
            });
            
            // åˆå§‹æ›´æ–°è¿›åº¦æ˜¾ç¤º
            updateProgressDisplay();
            // ========== ã€ä¼˜åŒ–ã€‘å¯åŠ¨å›¾ç‰‡æ‡’åŠ è½½ ==========
            setTimeout(() => {
                const imagePool = document.getElementById('image-pool');
                if (imagePool) {
                    // 1. ä¼˜å…ˆåŠ è½½å‰6å¼ ï¼ˆç”¨æˆ·æœ€å¯èƒ½å…ˆçœ‹åˆ°çš„ï¼‰
                    const firstBatch = Array.from(imagePool.children).slice(0, 6);
                    firstBatch.forEach(imgEl => {
                        const url = imgEl.dataset.src;
                        if (url) ImageLoader.loadLazy(imgEl, url);
                    });
                    
                    // 2. å»¶è¿ŸåŠ è½½å‰©ä½™å›¾ç‰‡
                    setTimeout(() => {
                        const remaining = Array.from(imagePool.children).slice(6);
                        remaining.forEach(imgEl => {
                            const url = imgEl.dataset.src;
                            if (url) ImageLoader.loadLazy(imgEl, url);
                        });
                    }, 800); // å»¶è¿Ÿ0.8ç§’åŠ è½½ç¬¬äºŒæ‰¹
                }
            }, 300); // é¡µé¢æ¸²æŸ“åç¨ç­‰0.3ç§’å¼€å§‹åŠ è½½
        }

        // ==================== å¢å¼ºçš„æ‹–æ‹½åŠŸèƒ½å®ç° ====================
        function setupDragAndDrop() {
            let draggedElement = null;
            let dragOffset = { x: 0, y: 0 };
            let dragGhost = null;

            // é¼ æ ‡æŒ‰ä¸‹ï¼šå¼€å§‹æ‹–æ‹½ï¼ˆå¯ä»¥ä»å›¾ç‰‡æ± æˆ–æ’åºåŒºæ‹–æ‹½ï¼‰
            document.addEventListener('mousedown', function(e) {
                const imgElement = e.target.closest('.draggable-img');
                if (!imgElement) return;
                
                e.preventDefault();
                draggedElement = imgElement;
                
                // è®¡ç®—é¼ æ ‡åœ¨å…ƒç´ å†…çš„åç§»é‡
                const rect = imgElement.getBoundingClientRect();
                dragOffset.x = e.clientX - rect.left;
                dragOffset.y = e.clientY - rect.top;
                
                // åˆ›å»ºæ‹–æ‹½æ—¶çš„"å¹½çµ"å›¾åƒï¼ˆè§†è§‰åé¦ˆï¼‰
                dragGhost = imgElement.cloneNode(true);
                dragGhost.classList.add('dragging');
                dragGhost.style.position = 'fixed';
                dragGhost.style.left = rect.left + 'px';
                dragGhost.style.top = rect.top + 'px';
                dragGhost.style.width = rect.width + 'px';
                dragGhost.style.height = rect.height + 'px';
                dragGhost.style.pointerEvents = 'none';
                dragGhost.style.zIndex = '10000';
                document.body.appendChild(dragGhost);
                
                // è®°å½•æ‹–æ‹½å¼€å§‹äº‹ä»¶
                EXPERIMENT.dragEvents.push({
                    type: 'drag_start',
                    imageId: parseInt(imgElement.dataset.id),
                    timestamp: Date.now() - EXPERIMENT.timestamps.experimentStart
                });
            });

            // é¼ æ ‡ç§»åŠ¨ï¼šæ›´æ–°å¹½çµä½ç½®å’Œé«˜äº®ç›®æ ‡
            const handleMouseMove = (e) => {
                if (!draggedElement || !dragGhost) return;
                
                // æ›´æ–°å¹½çµä½ç½®
                dragGhost.style.left = (e.clientX - dragOffset.x) + 'px';
                dragGhost.style.top = (e.clientY - dragOffset.y) + 'px';
                
                // é«˜äº®å¯èƒ½çš„ç›®æ ‡æ§½ä½
                document.querySelectorAll('.rank-slot').forEach(slot => {
                    const rect = slot.getBoundingClientRect();
                    const isOver = e.clientX >= rect.left && e.clientX <= rect.right &&
                                  e.clientY >= rect.top && e.clientY <= rect.bottom;
                    slot.classList.toggle('drag-over', isOver);
                });
            };

            // é¼ æ ‡é‡Šæ”¾ï¼šå¤„ç†æ”¾ç½®
            const handleMouseUp = (e) => {
                if (!draggedElement) return;
                
                // ç§»é™¤å¹½çµ
                if (dragGhost && dragGhost.parentNode) {
                    document.body.removeChild(dragGhost);
                }
                dragGhost = null;
                
                // ç§»é™¤æ‰€æœ‰é«˜äº®
                document.querySelectorAll('.rank-slot.drag-over').forEach(s => {
                    s.classList.remove('drag-over');
                });
                
                // æŸ¥æ‰¾æ”¾ç½®çš„ç›®æ ‡æ§½ä½
                let targetSlot = null;
                const slots = document.querySelectorAll('.rank-slot');
                
                for (const slot of slots) {
                    const rect = slot.getBoundingClientRect();
                    if (e.clientX >= rect.left && e.clientX <= rect.right &&
                        e.clientY >= rect.top && e.clientY <= rect.bottom) {
                        targetSlot = slot;
                        break;
                    }
                }
                
                // å¦‚æœæ‰¾åˆ°ç›®æ ‡æ§½ä½ï¼Œæ”¾ç½®æˆ–äº¤æ¢å›¾ç‰‡
                if (targetSlot) {
                    placeOrSwapImage(draggedElement, targetSlot);
                }
                
                // æ¸…ç†äº‹ä»¶ç›‘å¬
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
                draggedElement = null;
            };

            // å½“å¼€å§‹æ‹–æ‹½æ—¶æ·»åŠ å…¨å±€ç›‘å¬
            document.addEventListener('mousedown', function startDragListener(e) {
                const imgElement = e.target.closest('.draggable-img');
                if (imgElement) {
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                    // ä¸€æ¬¡æ€§ç›‘å¬å™¨
                    document.addEventListener('mouseup', function removeListeners() {
                        document.removeEventListener('mousemove', handleMouseMove);
                        document.removeEventListener('mouseup', handleMouseUp);
                        document.removeEventListener('mouseup', removeListeners);
                    }, { once: true });
                }
            });

            // ç‚¹å‡»å·²æ’åºå›¾ç‰‡æ”¾å›å›¾ç‰‡æ± çš„åŠŸèƒ½
            document.addEventListener('click', function(e) {
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†å·²æ”¾å…¥æ’åºæ§½çš„å›¾ç‰‡
                const clickedImg = e.target.closest('.draggable-img.in-slot');
                if (!clickedImg) return;
                
                // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…ä¸å…¶ä»–ç‚¹å‡»äº‹ä»¶å†²çª
                e.stopPropagation();
                
                // è·å–å›¾ç‰‡IDå’Œå½“å‰æ’å
                const imgId = parseInt(clickedImg.dataset.id);
                const currentRank = EXPERIMENT.finalRanking[imgId];
                
                if (currentRank !== null) {
                    // æ¸…ç©ºå¯¹åº”çš„æ’åºæ§½
                    EXPERIMENT.finalRanking[imgId] = null;
                    document.getElementById(`img-in-slot-${currentRank}`).style.backgroundImage = '';
                    const slotElement = document.getElementById(`slot-${currentRank}`);
                    slotElement.classList.remove('filled');
                    slotElement.classList.add('empty');
                    
                    // å°†å›¾ç‰‡æ”¾å›å›¾ç‰‡æ± 
                    clickedImg.classList.remove('in-slot');
                    clickedImg.classList.add('in-pool');
                    
                    // è®°å½•æ”¾å›äº‹ä»¶
                    EXPERIMENT.dragEvents.push({
                        type: 'return_to_pool',
                        imageId: imgId,
                        fromRank: currentRank,
                        timestamp: Date.now() - EXPERIMENT.timestamps.experimentStart
                    });
                    
                    // æ›´æ–°è¿›åº¦æ˜¾ç¤º
                    updateProgressDisplay();
                }
            });
        }

        /**
         * æ”¾ç½®æˆ–äº¤æ¢å›¾ç‰‡çš„æ ¸å¿ƒå‡½æ•°
         * @param {HTMLElement} imgElement è¢«æ‹–æ‹½çš„å›¾ç‰‡å…ƒç´ 
         * @param {HTMLElement} slotElement ç›®æ ‡æ’åºæ§½å…ƒç´ 
         */
        function placeOrSwapImage(imgElement, slotElement) {
            const draggedImgId = parseInt(imgElement.dataset.id);
            const targetSlotRank = parseInt(slotElement.dataset.rank);
            const targetSlotImgElement = document.getElementById(`img-in-slot-${targetSlotRank}`);
            
            // æƒ…å†µA: ç›®æ ‡æ§½å·²æœ‰å›¾ç‰‡ -> äº¤æ¢
            if (targetSlotImgElement.style.backgroundImage) {
                // 1. æ‰¾åˆ°å æ®ç›®æ ‡æ§½çš„å›¾ç‰‡ID
                let existingImgId = null;
                for (let i = 0; i < EXPERIMENT.finalRanking.length; i++) {
                    if (EXPERIMENT.finalRanking[i] === targetSlotRank) {
                        existingImgId = i;
                        break;
                    }
                }
                
                // 2. å¦‚æœè¢«æ‹–æ‹½çš„å›¾ç‰‡æœ¬èº«ä¹Ÿåœ¨æŸä¸ªæ§½ä¸­ï¼Œå…ˆæ¸…ç©ºåŸæ§½
                const draggedImgOldRank = EXPERIMENT.finalRanking[draggedImgId];
                if (draggedImgOldRank !== null && draggedImgOldRank !== targetSlotRank) {
                    EXPERIMENT.finalRanking[draggedImgId] = null;
                    document.getElementById(`img-in-slot-${draggedImgOldRank}`).style.backgroundImage = '';
                    document.getElementById(`slot-${draggedImgOldRank}`).classList.replace('filled', 'empty');
                    
                    // å°†åŸä½ç½®è®©ç»™ç›®æ ‡æ§½çš„å›¾ç‰‡ (å®Œæˆäº¤æ¢)
                    if (existingImgId !== null) {
                        EXPERIMENT.finalRanking[existingImgId] = draggedImgOldRank;
                        document.getElementById(`img-in-slot-${draggedImgOldRank}`).style.backgroundImage = 
                            `url('${.imageUrls[existingImgId]}')`;
targetSlotImgElement.classList.add('loaded'); // æ·»åŠ è¿™ä¸€è¡Œ
                        document.getElementById(`slot-${draggedImgOldRank}`).classList.replace('empty', 'filled');
                        document.getElementById(`img-${existingImgId}`).classList.replace('in-slot', 'in-pool');
                    }
                }
                
                // 3. å°†æ‹–æ‹½çš„å›¾ç‰‡æ”¾å…¥ç›®æ ‡æ§½
                EXPERIMENT.finalRanking[draggedImgId] = targetSlotRank;
                targetSlotImgElement.style.backgroundImage = `url('${CONFIG.imageUrls[draggedImgId]}')`;
                targetSlotImgElement.classList.add('loaded'); // æ·»åŠ è¿™ä¸€è¡Œ
                // 4. æ›´æ–°è¢«äº¤æ¢å›¾ç‰‡çš„è§†è§‰çŠ¶æ€
                if (existingImgId !== null) {
                    document.getElementById(`img-${existingImgId}`).classList.remove('in-slot');
                    document.getElementById(`img-${existingImgId}`).classList.add('in-pool');
                }
                
            } 
            // æƒ…å†µB: ç›®æ ‡æ§½ä¸ºç©º -> ç›´æ¥æ”¾ç½®
            else {
                // å¦‚æœè¢«æ‹–æ‹½å›¾ç‰‡å·²æœ‰ä½ç½®ï¼Œå…ˆæ¸…ç©º
                const oldRank = EXPERIMENT.finalRanking[draggedImgId];
                if (oldRank !== null) {
                    document.getElementById(`img-in-slot-${oldRank}`).style.backgroundImage = '';
                    document.getElementById(`slot-${oldRank}`).classList.replace('filled', 'empty');
                }
                
                // æ”¾å…¥æ–°ä½ç½®
                EXPERIMENT.finalRanking[draggedImgId] = targetSlotRank;
                targetSlotImgElement.style.backgroundImage = `url('${CONFIG.imageUrls[draggedImgId]}')`;
            }
            
            // ç»Ÿä¸€æ›´æ–°æ‹–æ‹½å›¾ç‰‡å’Œç›®æ ‡æ§½çš„è§†è§‰çŠ¶æ€
            imgElement.classList.remove('in-pool');
            imgElement.classList.add('in-slot');
            slotElement.classList.remove('empty');
            slotElement.classList.add('filled');
            
            // è®°å½•äº‹ä»¶
            EXPERIMENT.dragEvents.push({
                type: 'drop_or_swap',
                imageId: draggedImgId,
                toRank: targetSlotRank,
                timestamp: Date.now() - EXPERIMENT.timestamps.experimentStart
            });
            
            updateProgressDisplay();
        }

        /**
         * æ›´æ–°æ’åºè¿›åº¦æ˜¾ç¤º
         */
        function updateProgressDisplay() {
            const filledCount = EXPERIMENT.finalRanking.filter(rank => rank !== null).length;
            const progressElement = document.getElementById('progress-display');
            const continueButton = document.getElementById('continue-btn');
            
            if (progressElement) {
                progressElement.textContent = `å·²æ’åºï¼š${filledCount} / 12 å¼ å›¾ç‰‡`;
                if (filledCount === 12) {
                    progressElement.textContent = 'âœ… æ’åºå®Œæˆï¼æ‚¨å¯ä»¥ç»§ç»­è°ƒæ•´ï¼Œæˆ–ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç»§ç»­ã€‚';
                    progressElement.classList.add('complete');
                    EXPERIMENT.isSortingComplete = true;
                } else {
                    progressElement.classList.remove('complete');
                    EXPERIMENT.isSortingComplete = false;
                }
            }
            
            if (continueButton) {
                continueButton.disabled = filledCount < 12;
            }
        }

        // ==================== é˜¶æ®µå››ï¼šé€‰æ‹©ä»»åŠ¡æŒ‡å¯¼è¯­ (åŒ…å«åº“å­˜ä¸è¶³ç†ç”±) ====================
        function showChoiceInstructions() {
            const html = `
                <div class="header">
                    <h1>ä¸‹ä¸€æ­¥ï¼šé€‰æ‹©ç¬”è®°æœ¬å°é¢</h1>
                    <p>æ„Ÿè°¢æ‚¨å®Œæˆå›¾ç‰‡æ’åº</p>
                </div>
                <div class="main-content">
                    <div class="instructions">
                        <h2>é€‰æ‹©è¯´æ˜</h2>
                        <p>ç”±äº<b>åº“å­˜é™åˆ¶</b>ï¼Œæˆ‘ä»¬åªèƒ½ä¸ºæ‚¨æä¾›ä»¥ä¸‹ <b>5å¼ å›¾ç‰‡</b> ä½œä¸ºå°é¢çš„é€‰æ‹©ã€‚</p>
                        <p>è¯·æ‚¨ä»è¿™5å¼ å›¾ç‰‡ä¸­ï¼Œé€‰æ‹© <b>1å¼ </b> ä½œä¸ºæ‚¨ç¬”è®°æœ¬çš„æœ€ç»ˆå°é¢ã€‚</p>
                        <p style="color: #4a5568; margin-top: 15px; padding: 10px; background: #edf2f7; border-radius: 6px;">
                            <b>æ“ä½œæç¤ºï¼š</b> ç‚¹å‡»æ‚¨é€‰æ‹©çš„å›¾ç‰‡å³å¯é€‰ä¸­ï¼Œç„¶åç‚¹å‡»ç¡®è®¤æŒ‰é’®ã€‚
                        </p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 40px;">
                        <button id="start-choice-btn" class="action-button">å¼€å§‹é€‰æ‹©å°é¢</button>
                    </div>
                </div>
            `;
            
            document.getElementById('experiment-container').innerHTML = html;
            document.getElementById('start-choice-btn').addEventListener('click', showChoiceStage);
        }

        // ==================== é˜¶æ®µäº”ï¼šé€‰æ‹©ä»»åŠ¡ (å›¾ç‰‡éšæœºåŒ–å‘ˆç°) ====================
        function showChoiceStage() {
            currentStage = 'choice';
            EXPERIMENT.timestamps.choiceStart = Date.now();
            
            // è·å–æ’åç¬¬4åˆ°ç¬¬8çš„å›¾ç‰‡
            const eligiblePosters = [];
            EXPERIMENT.finalRanking.forEach((rank, posterId) => {
                if (rank >= 4 && rank <= 8) eligiblePosters.push({ posterId, rank });
            });
            
            // éšæœºæ‰“ä¹±å›¾ç‰‡çš„å‘ˆç°é¡ºåº
            for (let i = eligiblePosters.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [eligiblePosters[i], eligiblePosters[j]] = [eligiblePosters[j], eligiblePosters[i]];
            }
            
            const html = `
                <div class="header">
                    <h1>è¯·é€‰æ‹©æ‚¨çš„ç¬”è®°æœ¬å°é¢</h1>
                    <p>ç‚¹å‡»ä¸‹æ–¹æ‚¨æœ€å–œæ¬¢çš„ä¸€å¼ å›¾ç‰‡</p>
                </div>
                <div class="main-content" style="text-align: center;">
                    <p style="color: #666; margin-bottom: 20px;">è¯·ä»ä»¥ä¸‹5å¼ å›¾ç‰‡ä¸­é€‰æ‹©1å¼ ï¼š</p>
                    
                    <div id="choice-options" class="choice-options-container">
                        ${eligiblePosters.map(item => `
                            <div class="choice-option"
                                 data-poster-id="${item.posterId}"
                                 data-src="${CONFIG.imageUrls[item.posterId]}">
                            </div>
                        `).join('')}
                    </div>
                    
                    <div id="choice-feedback" style="min-height: 30px; margin-top: 20px;"></div>
                    
                    <div class="control-area">
                        <button id="confirm-choice-btn" class="action-button" disabled>ç¡®è®¤é€‰æ‹©</button>
                    </div>
                </div>
            `;
            
            document.getElementById('experiment-container').innerHTML = html;
            
            // è®¾ç½®é€‰æ‹©äº‹ä»¶
            const options = document.querySelectorAll('.choice-option');
            const feedback = document.getElementById('choice-feedback');
            const confirmBtn = document.getElementById('confirm-choice-btn');
            
            options.forEach(opt => {
                opt.addEventListener('click', function() {
                    options.forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    const selectedId = parseInt(this.dataset.posterId);
                    EXPERIMENT.selectedImageId = selectedId;
                    
                    feedback.textContent = `âœ… æ‚¨å·²é€‰æ‹©æ­¤å›¾ç‰‡ä½œä¸ºå°é¢ã€‚`;
                    feedback.style.color = '#00cec9';
                    
                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                    }
                });
            });
            
            confirmBtn.addEventListener('click', finishExperiment);
            
            // ========== ã€ä¼˜åŒ–ã€‘åŠ è½½é€‰æ‹©é˜¶æ®µçš„å›¾ç‰‡ ==========
            setTimeout(() => {
                document.querySelectorAll('.choice-option').forEach(option => {
                    const url = option.dataset.src;
                    if (url) ImageLoader.loadLazy(option, url);
                });
            }, 100);
        }

        // ==================== é˜¶æ®µå…­ï¼šå®Œæˆå®éªŒ (ç”Ÿæˆä¸¤ä»½æ•°æ®æ–‡ä»¶ï¼Œç®€åŒ–å®Œæˆç•Œé¢) ====================
        function finishExperiment() {
            currentStage = 'finish';
            EXPERIMENT.timestamps.choiceEnd = Date.now();
            
            // å‡†å¤‡æœ€ç»ˆæ•°æ®
            const finalData = prepareFinalData();
            
            console.log('å®éªŒæ•°æ®æ”¶é›†å®Œæˆ:', finalData);
            
            // è‡ªåŠ¨ä¿å­˜ä¸¤ä»½æ•°æ®æ–‡ä»¶ï¼ˆåœ¨åå°è¿›è¡Œï¼Œä¸æç¤ºè¢«è¯•ï¼‰
            saveDataAsJSON(finalData); // å®Œæ•´çš„JSONæ•°æ®
            generateAndDownloadSummary(finalData); // å¯è¯»çš„TXTæ‘˜è¦
            
            // æ˜¾ç¤ºç®€æ´çš„å®Œæˆé¡µé¢ï¼ˆåªå‘ŠçŸ¥è¢«è¯•å®éªŒå®Œæˆï¼‰
            document.getElementById('experiment-container').innerHTML = `
                <div class="header" style="background: linear-gradient(135deg, #38a169 0%, #276749 100%);">
                    <h1>âœ… å®éªŒå®Œæˆï¼</h1>
                    <p>æ„Ÿè°¢æ‚¨çš„å‚ä¸</p>
                </div>
                <div class="main-content">
                    <div class="completion-screen">
                        <div class="completion-icon">âœ…</div>
                        <h2>å®éªŒå·²æˆåŠŸå®Œæˆ</h2>
                        <p>æ„Ÿè°¢æ‚¨çš„è®¤çœŸå‚ä¸ï¼</p>
                        <p>æ‚¨çš„æ•°æ®å·²è‡ªåŠ¨ä¿å­˜ã€‚</p>
                        <p style="color: #718096; margin-top: 40px; font-size: 0.9em;">
                            æ‚¨å¯ä»¥å®‰å…¨å…³é—­æ­¤æµè§ˆå™¨çª—å£ã€‚
                        </p>
                    </div>
                </div>
            `;
        }

        // ==================== å¯åŠ¨å®éªŒ ====================
        // é¡µé¢åŠ è½½å®Œæˆåï¼Œæ˜¾ç¤ºIDè¾“å…¥ç•Œé¢
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', showIdInput);
        } else {
            showIdInput();
        }
    </script>
</body>

</html>

